## 第四章 数据加密 

### 密码学简史

密码学是一门历史悠久的学科，大致可以将其发展分为以下三个阶段：

-   **古典密码**：主要是通过替换和移位等简单手段来加密信息。
-   **近代密码**：包括复杂的机械或电子密码机，如二战期间的德国恩尼格玛密码机。
-   **现代密码**：主要指的是计算机时代的密码技术，比如公钥密码和哈希函数等。

#### 隐写术与密码学

隐写术和密码学是信息隐藏领域的两个重要分支。他们都关注如何将信息安全地传递到接收者，但是方法和目的有所不同。

-   **隐写术**：源自希腊语，意为“隐秘书写”。它是一门关于信息隐藏的技巧和科学，主要是将信息隐藏在其他无害的信息中，以达到传递秘密信息的目的。
-   **密码学**：源自希腊语，意为“隐藏的书写”。它是一门研究如何隐密地传递信息的学科。密码学的目的不仅仅是隐藏信息，而是确保信息的安全性，包括保密性、完整性和可用性等。

密码学者 *Ron Rivest* 的名言：“密码学是关于如何在敌人存在的环境中通讯”。

#### 密码学的基本概念

-   **密码编码**：通过信息编码使信息保密。
-   **密码分析**：用分析方法解密信息。
-   **基本术语**：
    -   明文(plain text)：原始要加密的信息。
    -   密文(cipher text)：经过加密的信息。
    -   加密(encrypt, encryption)：将明文转化为密文的过程。
    -   解密(decrypt, decryption)：将密文转化为明文的过程。
    -   密码算法(Algorithm)、密码(Cipher)：用来加密和解密的数学函数。
    -   密钥(Key)：密码算法中的一个变量。

密码编码主要有以下两种操作：

-   **代替**：每个明文元素映射为另一个元素。（代换）
-   **换位**：明文中的元素重新排列。（置换）

针对密钥的数量，有以下两种加密方式：

-   **对称加密**：同一个密钥既用于加密又用于解密。
-   **非对称加密**：使用一对密钥，一个用于加密，另一个用于解密。

对明文加密的方式主要有：

-   **块加密**：一次处理一个数据块进行加密。
-   **流加密**：一次处理一个数据单元进行加密。

#### 密码技术的主要用途

-   **数据保密**：通过数据加密和解密保护数据的私密性。
-   **认证技术**：实体身份认证和数据源发认证。
-   **信息完整性保护**：保证信息在传输过程中没有被插入、篡改、重发。
-   **数字签名和抗抵赖**：源发抗抵赖和交付抗抵赖。



#### 古典密码

古典密码主要包括：

-   **代替密码 (Substitution Cipher)**
-   **换位密码 (Transposition Cipher)**
-   **代替密码与换位密码的组合**

这些密码体制的安全性主要依赖于保持算法**本身**的保密性。然而，它们都存在以下缺陷：

-   受限算法的缺陷
-   不适合大规模使用
-   不适合人员变动较大的组织
-   用户无法了解算法的安全性

##### Eg. 凯撒密码

凯撒密码是一种代替密码，它将英文字母向前移动k位。

##### Eg. 猪圈密码

##### Eg. 纵行换位密码

纵行换位密码是一种换位密码，明文的字母保持相同，但顺序被打乱了。例如，明文 "Can you understand" 在纵行换位密码中将被转化为 "Codtaueanurnynsd"。这种密码在美国南北战争中得到了广泛的应用。

##### Eg. 戚继光反切码

戚继光反切码源自反切拼音注音方法，是用两个字为另一个字注音，取上字的声母和下字的韵母，"切"出另外一个字的读音。例如，明文 "5-25-2" 在戚继光反切码中将被转化为 "敌"。

#### 近代密码

**近代密码** 的核心是将**算法和密钥分开**。在这种方式中，**密码算法可以公开，密钥保密**，从而将密码系统的安全性放在**保持密钥的保密性**上。

#### ENIGMA机

**ENIGMA机** 是一个由 *Arthur Scherbius* 在1919年发明并在1926年被德军装备的转轮密码机。这个机器使用了一系列的转轮和连接板来创建复杂的加密过程。

-   **工作原理**：它的工作方式基于三个核心要素：转子的初始设置，转子之间的相互位置，以及连接板连线的状况，这三者组合构成了所有可能的密钥。此外，由于每个转子的旋转，使得可能的加密变化在每次输入时都会变化。
-   **工作过程**：
    - 根据密码本取得当日密钥
    - 首先发送一个新的密钥
    - 随机地选择三个字母，比如说PGH
    - 把PGH在键盘上连打两遍，加密为比如说KIVBJE（注意两次PGH被加密为不同的形式）
    - 把KIVBJE放在在电文的最前面
    - 重新调整三个转子的初始方向到PGH
    - 正式对明文加密

#### 对称密钥密码系统的缺陷

**对称密钥密码系统** 在实践中表现出三个主要的缺陷：

1.  密钥必须经过安全的信道分配。
2.  无法用于数字签名。
3.  密钥管理复杂，随着用户数量的增加，密钥的数量将呈指数级增长，这是因为每个用户都需要与每个其他用户有一个唯一的密钥。

#### 现代密码

现代密码的发展在很大程度上归功于**Diffie和Hellman**在1976年的文章《New Direction in Cryptography》中提出的**公钥密码**的概念。这个概念引入了两个密钥的使用，对密钥分配、数字签名、认证等方面产生了深远的影响。此外，他们的方法基于数学函数，而不是代替和换位，被视为密码学历史上唯一的一次真正的革命，实现了密码学发展史上的第二次飞跃。

#### 量子密码

**量子密码** 是一个新兴的密码体系，它采用量子态作为信息载体，经由量子通道在合法的用户之间传送密钥。它的安全性由量子力学原理所保证。

-   **工作原理**：量子密码利用光的偏振状态来编码信息。例如，“水平垂直方向”偏振和“对角方向”偏振可以被用来代表二进制的0和1。
-   **量子密钥生成方法**：在量子密码中，发送方生成并发送偏振，接收方则进行测量。由于量子力学的原理，任何未经授权的测量都会改变量子态，从而被检测到。



### 对称密码&#x20;

**对称密码**是使用相同的密钥（$K_E=K_D$）进行加密和解密的密码系统。这种系统的密钥需要通过**秘密的信道**进行分配。常用的对称密钥密码算法包括 **DES** (Data Encryption Standard) 及其各种变体和 **AES** (Advanced Encryption Standard) 和 RC5, Blowfish 等

#### 对称密码算法的两条基本设计原则 (P35)

1.  **扩散（Diffusion）**：重新排列消息中的每一个比特，使明文中的冗余度能够扩散到整个密文，将每一个比特明文的影响尽可能作用到较多的输出密文位中。
2.  **扰乱（Confusion）**：密文和密钥之间的统计特性关系尽可能复杂化。如果密钥的一位发生变化，密文的绝大多数位也发生变化。这两种设计原则是由信息论的创始人克劳德·艾尔伍德·香农提出的。

**多次迭代**是基本设计方法

#### 分组密码

**分组密码**（Block Cipher）是每次只能处理特定长度的一块数据的一类密码算法。对不同分组主要有5种迭代模式

- **ECB 模式**
  - Electronic CodeBook 电子密码模式
  
  - 明文分组加密后的结果直接作为密文分组
  
  - 优点
  
    - 每个分组的处理相互独立，可以并行操作
  
    - 一个密文块传输错误不会影响后续密文解密
  
  - 缺点
    - 由于分组相互独立，信息块可被替换、重排、删除、重放，对明文的**主动攻击**是可能的
    - 无法纠正传输中的**同步错误**（如果密文在传输中增加或丢失一个 bit，将引起密文分组的对齐错误，整个密文序列将不能正确解密）
  
- **CBC 模式**
  - Cipher Block Chaining 密码分组链接模式
  - 每个明文块先与前一个密文块相异或，再进行加密
  - 优点
    - 能够隐藏明文的数据模式：相同的明文可对应不同的密文
    - 能在一定程度上抵抗主动攻击：信息块不容易被替换、重排、删除、重放
    - 误差有限传递：密文中一个位的错误只影响当前分组和下一个分组的解密
  - 缺点：加密不支持并行计算
  
- **CFB 模式**
  - Cipher FeedBack 密文反馈模式
  - 加密算法的输入为上一次的密文以及加密用的密钥
  - 明文不进入加密算法中处理，而是与加密算法的输出异或得到密文
  - 优点
    - 能够隐藏明文的数据模式
    - 抵抗主动攻击
    - 解密支持并行计算
  - 缺点
    - 加密不支持并行计算
    - 一个密文块传输错误会影响后续密文解密
  
- **OFB 模式**
  - Output Feedback 输出反馈模式
  - 每次加密时，将密码算法的输出反馈至输入中，即上一轮加密算法的输出会作为下一轮加密算法的输入
  - 优点
    - 没有错误传播，一个密文单元的损坏只影响本单元的解密
  - 缺点
    - 对密文的主动攻击难以检测
    - 加密不支持并行计算
  
- **CTR 模式**
  - Counter 计数器模式
  - 将逐次累加的计算器进行加密生成密钥流
  - 优点
    - 可以随机对任意一个密文分组解密，并行加解密
  - 缺点：对密文主动攻击难以预测

#### DES

- 把明文分成 64 bit 为单位的块 m，对于每个 m,  执行如下操作
- $DES(m)=IP^{-1} \cdot T_{16} \cdot T_{15} \cdot..... T_2 \cdot T_1 \cdot IP(m)$
  - 初始置换 $IP$ 
  - 16轮迭代  $T_i$ ,  $i=1,2,…16$
  - 末置换 $IP^{-1}$
- 函数 $T$ 的设计
- 一般设计准则：随机性，雪崩效应，非线性，完全性，相关关系免疫性

#### 流密码

##### Eg. 一次性密码本

- 将信息的明文与一串随机的比特序列进行异或运算
- 无法被破译：无法判断是否为正确的明文
- 局限性
  - 密钥长度与明文相同
  - 密钥分发，密钥保存，密钥重用，密钥同步，密钥生成



### 公钥密码

#### 解决密钥分发问题

-   **事先共享密钥**：在加密通信之前，以安全的方式将密钥交给接收方。
-   **通过密钥分配中心（Key Distribution Center，KDC）**：当参与加密通信的人过多时，可以使用 KDC。当需要进行加密通信时，KDC 会生成一个通信密钥，每个人只需和 KDC 事先共享密钥即可。
-   **通过 Diffie-Hellman 密钥交换**：进行加密通信的双方仅需要交换一些信息，即使这些信息被窃听，也无法对算法进行解密，而通信双方则可以通过这些信息各自生成相同的密钥。
-   **通过公钥密码**：由于加解密使用不同的密钥，所以无需进行密钥分发。

#### 公钥密码系统的加密原理

在公钥密码系统中，每个通信实体都有一对密钥（公钥和私钥）

公钥公开，用于加密和验证签名；私钥保密，用于解密和签名。

- A 向 B 发送消息，用 B 的公钥加密。B 收到密文后，用自己的私钥解密

#### 公钥密码系统的签名原理

A 向 B 发送消息，用自己的私钥签名。B 收到密文后，用 A 的公钥验证

#### 公钥密码算法的表示

-   **对称密钥密码**
    -   密钥：会话密钥 ($Ks$)
    -   加密函数：$C = E_{Ks}[P]$
    -   对密文$C$，解密函数：$P=D_{Ks}[C]$
-   **公开密钥**
    -   (公钥，私钥)：($KUa$，$KRa$)
    -   加密/签名：$C= E_{KUb}[P]$，$E_{KRa}[P]$
    -   解密/验证：$P= D_{KRb}[C]$，$D_{KUa}[C]$

#### 对公开密钥密码算法的要求

-   参与方 B 能容易地生成密钥对 ($KUb$, $KRb$)。
-   已知 $KUb$，A 的加密操作应该是容易的：$C=E_{KUb}[P]$
-   已知 $KRb$，B 的解密操作应该是容易的：$P=D_{KRb}[C]$ 
-   已知 $KUb$，求 $KRb$ 应该是在计算上不可行的
-   已知 $KUb$ 和 $C$，欲恢复明文 $P$ 应该是在计算上不可行的

#### 对公钥密码算法的误解

1.  公开密钥算法比对称密钥密码算法更安全：
    - 任何一种算法的安全性都依赖于**密钥长度**和**破译密码的工作量**
    - 从抗分析的角度来看，没有哪一种算法是绝对优越的
2.  公开密钥算法使对称密钥成为过时的技术：
    - 公开密钥算法**运行速度较慢**，只能用在**密钥管理**和**数字签名**上
    - 因此，对称密钥密码算法仍将长期存在
3.  使用公开密钥加密，密钥分配非常简单：
    - 事实上的密钥分配既不简单也不有效

#### RSA算法

- RSA算法是由 Ron **R**ivest、Adi **S**hamir 和 Leonard **A**dleman 开发的一种公钥加密算法
- RSA的安全性基于**大数分解**的难度
- RSA已经成为事实上的工业标准，可用于**公钥密码**和**数字签名**

##### 性能表现

- RSA 的安全性主要取决于**大数分解**（两个素数乘积的因子分解）的难度
- 在实际运行中，RSA 的速度比 DES 慢 100 倍以上

##### 操作过程

- RSA算法的操作过程包括**密钥产生**和**加密/解密**两个部分
- **密钥产生**：
  - 取两个大素数 $p$ 和 $q$，计算 $n=pq$，公开 $n$
  - 计算欧拉函数 $\phi(n)=(p-1)(q-1)$
  - 选取一个与 $\phi(n)$ 互素的整数 $e$，即 $gcd(e, ϕ(n))=1$，$1<e<ϕ(n)$
  - 找到一个整数 $d$，使得 $de≡1 (mod \phi(n))$，即 $de = k\phi(n) + 1$
  - 将 $d$ 保密，公开  $(e,n)$
- **加密/解密**：
  - 公钥 $KU=\{e, n\}$，私钥 $KR=\{d, n\}$
  - 加密过程
    - 把待加密的内容分成 $k$ 比特的分组 $k≤ log_2n$，并写成数字 $M$
    - $C=M^e mod \ n$
  - 解密过程：$M=C^d mod \ n$

##### 应用

公钥密码系统主要用于**加密/解密**、**数字签名**和**密钥交换**

- RSA可以用于这三种应用
- D-H 算法只能用于密钥交换
- DSA 则只能用于数字签名

#### 公钥基础设施 PKI

**CA (Certificate Authority)**：可信赖的第三方权威机构，负责给网络实体颁发身份证明书

**PKI (Public Key Infrastructure)**：由 CA，数字证书等组成的公钥与身份验证体系

**数字证书**：虽然数字证书里只包含了公钥，但数字证书必须与其对应的私钥配合，才能实现各种功能（锁和钥匙的关系）

##### PKI 应用

- **HTTPS**：HTTPS 服务器需要向 PKI 认证中心（包括 CA 和证书存储库）申请证书，获得证书后才能建立 HTTPS 连接，供客户端访问
- **SSL VPN**：SSL VPN 网关、出差员工需要分别向 PKI 认证中心申请证书，之后通过内网建立连接

##### PKI 的扩展：RPKI

- 路由源认证 (Route Origin Authorization, **ROA**) 将 IP 前缀和路由源 AS ASN 绑定
- 层级结构，5个 RIR 作为根信任证书颁发机构 CA，形成根 CA 到 AS/ISP 的**信任链**
- **BGP 源验证**：根据 RC 证书链验证 ROA 合法性，通过 ROA 验证 BGP 合法性
- **BGP 路径验证**：通过 RC 证书链验证签名公钥的合法性，逐个 AS 对路径信息签名

##### PKI 安全机制：

1. **证书撤销列表**
   - 由 CA 维护，包含被撤销的证书序列号和撤销时间
   - 浏览器定期下载 CRL 列表用于校验证书是否已被撤销
2. **在线证书状态**
   - 在线证书状态协议 (Online Certificate Status Protocol, OCSP) 
   - 通过建立一个可实时响应的机制，CA 服务器实时响应验证证书

##### PKI 信任模型

1. **Web 信任模型**

   - 构建在 Web 浏览器的基础上，浏览器中内置多个根 CA

   - 根 CA 间是平行的，浏览器用户同时信任多个根 CA 并把这些根 CA 作为自己的信任锚

2. **交叉认证**

   - 将以前无关的 CA 连接在一起的机制，认证主体和颁发者都是 CA
   - 根据 CA 是否属于同一信任域，分为域内交叉认证和域间交叉认证

3. **桥 CA 信任模型**

   - 中心辐射式信任模型

##### PKI 的可能风险

1. **中心化监管带来问题**
   - CA 负责证书的颁发，撤销，合法性验证，利用证书透明机制保证证书安全
   - 证书的所有操作权利均归 CA 所有，在 CA 受到攻击后会带来严重的安全威胁
   - 中心化监管导致 PKI 面临中心节点的安全脆弱性和信任链失效
2. **证书颁发风险**
   - 包括误发证书，恶意颁发证书，钓鱼网站证书
3. **证书维护风险**
   - 证书的有效性能以验证，证书过期或撤销问题

##### 解决方案

- **监督机制**：
  - 证书透明机制（Certificate Transparency，CT）公开审计
  - 经济激励机制：监督 CA 而已证书者获得奖励金



### 摘要与签名

#### 散列函数

**散列函数**，又称哈希（Hash）函数，它可以把任意长度的消息压缩为固定长度的二进制串：散列值(hash value)：ℎ = 𝐻(𝑚)。散列函数是进行消息认证的基本方法，主要用于消息**完整性检测**和**数字签名**

数字签名是使用私钥加密证明自己是公钥所有者，而摘要是指哈希散列值。

#### 散列函数的性质

1.  可以根据任意长度的消息计算出固定长度的散列值。
2.  能够快速计算出散列值。
3.  单向性：根据消息计算出摘要，但不可反向。

#### 散列函数的安全性：HASH 碰撞

哈希碰撞是指不同的输入产生相同的哈希输出。这种情况在理论上是可能的，因为哈希函数接受任意长度的输入，但输出的长度是固定的。所以，存在两个不同的输入产生相同输出的可能性。如果这种碰撞能在实践中找到，那么哈希函数就被认为是不安全的。

#### 哈希算法实例

-   **MD5**: 生成128位的哈希值，广泛用于确保信息传输的完整无误。
-   **SHA-1**: 安全哈希算法，主要用于各种安全认证中，生成160位的哈希值。
-   **SHA-256**: 属于SHA-2标准下的哈希算法，生成256位的哈希值，被广泛用于比特币中。

#### 散列函数的应用: 比特币

比特币使用了SHA256、RIPEMD160这两种散列函数。SHA256用于区块的头部信息、交易数据、工作量证明、比特币地址等，输出256位的哈希值。而RIPEMD160则用于比特币地址生成，可以让地址更短，输出160位的哈希值。

#### SHA256算法

SHA256是SHA-2标准下细分出的一种散列函数。算法的实现主要分为三个步骤：常量初始化，信息预处理，生成摘要。

#### 消息认证码 (MAC)

**消息认证码（Message Authentication Code）的输入包括任意长度的消息和一个发送者与接受者之间共享的密钥，它可以输出固定长度的数据，这个数据称为**MAC值。

#### HMAC

**HMAC**是一种使用散列函数来构造消息认证码的方法。该方法所使用的散列函数不仅限于一种，任何高强度的散列函数都可以被用在HMAC。使用SHA-1，SHA-256，所构造的HMAC分别称为HMAC-SHA1，HMAC-SHA256。



### 公钥密码与数字签名

在**公钥密码**系统中，用公钥进行加密，用私钥进行解密。**数字签名**是用私钥加密的过程，用公钥进行验证。

#### 数字签名方法

直接对消息签名，或者对消息的摘要签名。

#### 数字签名的分类

包括盲签名（签名者不知道代签名文件内容时使用的数字签名）、门限签名（如果一个群体中有n个人，那么至少需要p个人签名才视为有效签名(n>p)）、群签名（一个群体由多个成员组成，某个成员可以代表整个群体来进行数字签名，而且该成员作为签名者可以被验证）、代理签名（密钥的所有者可以将签名权利授予第三方，获得权力的第三方可以进行数字签名）、双重签名（签名者希望有个中间人在他与验证者之间进行验证授权操作）。

#### 数字签名的应用

包括网站认证（通过对网站域名信息、主体身份信息、域名权属信息等进行严格鉴证审核，并利用PKI数字签名技术形成不可篡改的认证标识，在互联网终端以安全可靠的方式进行展示，使网民更直观确认网站的真实身份）、

比特币（比特币是一种完全匿名的数字货币，它的身份认证是基于ECDSA，比特币的账户地址就是对公钥计算摘要得到的，并用私钥确认账户拥有者）、

代码签名（如果Windows上的可执行程序程序来源于正规公司

### 密码分析技术

密码分析技术是在未知密钥的前提下，从密文恢复出明文、或者推导出密钥，对密码进行分析的尝试。

#### 唯密文攻击(Ciphertext only)

分析者有一些消息的密文，都是用同一算法加密的。分析者的目标是恢复尽量多的明文或者推算出密钥。

#### 已知明文攻击(Known Plaintext)

密码分析者不仅可以得到一些消息的密文，而且也知道这些消息的明文。分析者的任务是得到加密的密钥或者得到一个算法，该算法可以解密用同样的密钥加密的消息。

#### 选择明文攻击(Chosen Plaintext)

分析者不仅知道一些消息的明文和密文，而且可以选择被加密的明文，这比已知明文攻击更加有效。分析者的任务是得到加密的密钥或者得到一个算法，该算法可以解密用同样的密钥加密的消息。攻击者拥有加密机的访问权限，可构造所选一定数量的明文所对应的密文。

#### 选择密文攻击(Chosen Ciphertext)

密码分析者能选择不同的被加密的密文，并可以得到对应的解密的明文，密码分析者的任务是推出密钥。主要针对公钥算法。攻击者拥有解密机的访问权限，可构造所选一定数量的密文所对应的明文。

#### 相关密钥攻击(Related Key)

攻击者可以得到被两个不同的钥匙所加密（或解密）得到的密文（或明文）。攻击者不知道这两个钥匙的数值，但知道这两个钥匙之间的关系，比如两个钥匙之间相差一个比特。

#### 密码分析技术

密码算法的相对安全性的衡量标准包括破解算法的代价是否大于加密数据本身的价值，以及破解算法的时间是否超过了信息的生命期。对于不同密钥长度的加密，进行穷举密钥搜索所需的平均时间也会大不相同，随着密钥长度的增加，所需的时间将急剧增加。